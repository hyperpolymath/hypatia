# SPDX-License-Identifier: AGPL-3.0-or-later
name: Mirror to GitLab/Codeberg/Bitbucket

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions: read-all

concurrency:
  group: mirror-${{ github.ref }}
  cancel-in-progress: false

jobs:
  mirror-gitlab:
    runs-on: ubuntu-22.04
    if: vars.GITLAB_MIRROR_ENABLED == 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4
        with:
          fetch-depth: 0
      - name: Add GitLab SSH known hosts (pinned keys)
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Official GitLab.com SSH host keys - pinned for security
          # See: https://docs.gitlab.com/ee/user/gitlab_com/#ssh-host-keys-fingerprints
          cat >> ~/.ssh/known_hosts << 'EOF'
          gitlab.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAfuCHKVTjquxvt6CM6tdG4SLp1Btn/nOeHHE5UOzRdf
          gitlab.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCsj2bNKTBSpIYDEGk9KxsGh3mySTRgMtXL583qmBpzeQ+jqCMRgBqB98u3z++J1sKlXHWfM9dyhSevkMwSbhoR8XIq/U0tCNyokEi/ueaBMCvbcTHhO7FcwzY92WK4Yt0aGROY5qX2UKSeOvuP4D6TPqKF1onrSzH9bx9XUf2lEdWT/ia1NEKjunUqu1xOB/StKDHMoX4/OKyIzuS0q/T1zOATthvasJFoPrAjkohTyaDUz2LN5JoH839hViyEG82yB+MjcFV5MU3N1l1QL3cVUCh93xSaua1N85qivl+siMkPGbO5xR/En4iEY6K2XPASUEMaieWVNTRCtJ4S8H+9
          gitlab.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFSMqzJeV9rUzU4kWitGjeR4PWSa29SPqJ1fVkhtj3Hw9xjLVXVYrU9QlYWrOLXBpQ6KWjbjTDTdDkoohFzgbEY=
          EOF
          chmod 600 ~/.ssh/known_hosts
      - uses: webfactory/ssh-agent@dc588b651fe13675774614f8e6a936a468676387 # v0.9.0
        with:
          ssh-private-key: ${{ secrets.GITLAB_SSH_KEY }}
      - name: Mirror to GitLab
        run: |
          git remote add gitlab git@gitlab.com:hyperpolymath/${GITHUB_REPOSITORY#*/}.git || true
          git push gitlab --all --force
          git push gitlab --tags --force

  mirror-codeberg:
    runs-on: ubuntu-22.04
    if: vars.CODEBERG_MIRROR_ENABLED == 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4
        with:
          fetch-depth: 0
      - name: Add Codeberg SSH known hosts (with fingerprint verification)
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Fetch keys and verify against official fingerprints
          # See: https://docs.codeberg.org/security/ssh-fingerprint/
          ssh-keyscan -t ed25519 codeberg.org > /tmp/codeberg_keys 2>/dev/null
          FINGERPRINT=$(ssh-keygen -lf /tmp/codeberg_keys | grep ED25519 | awk '{print $2}')
          EXPECTED="SHA256:mIlxA9k46MmM6qdJOdMnAQpzGxF4WIVVL+fj+wZbw0g"
          if [ "$FINGERPRINT" != "$EXPECTED" ]; then
            echo "ERROR: Codeberg SSH key fingerprint mismatch!"
            echo "Expected: $EXPECTED"
            echo "Got: $FINGERPRINT"
            exit 1
          fi
          cat /tmp/codeberg_keys >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
      - uses: webfactory/ssh-agent@dc588b651fe13675774614f8e6a936a468676387 # v0.9.0
        with:
          ssh-private-key: ${{ secrets.CODEBERG_SSH_KEY }}
      - name: Mirror to Codeberg
        run: |
          git remote add codeberg git@codeberg.org:hyperpolymath/${GITHUB_REPOSITORY#*/}.git || true
          git push codeberg --all --force
          git push codeberg --tags --force

  mirror-bitbucket:
    runs-on: ubuntu-22.04
    if: vars.BITBUCKET_MIRROR_ENABLED == 'true'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4
        with:
          fetch-depth: 0
      - name: Add Bitbucket SSH known hosts (pinned keys)
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Official Bitbucket.org SSH host keys - pinned for security
          # See: https://bitbucket.org/site/ssh
          cat >> ~/.ssh/known_hosts << 'EOF'
          bitbucket.org ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIazEu89wgQZ4bqs3d63QSMzYVa0MuJ2e2gKTKqu+UUO
          bitbucket.org ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPIQmuzMBuKdWeF4+a2sjSSpBK0iqitSQ+5BM9KhpexuGt20JpTVM7u5BDZngncgrqDMbWdxMWWOGtZ9UgbqgZE=
          bitbucket.org ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDQeJzhupRu0u0cdegZIa8e86EG2qOCsIsD1Xw0xSeiPDlCr7kq97NLmMbpKTX6Esc30NuoqEEHCuc7yWtwp8dI76EEEB1VqY9QJq6vk+aySyboD5QF61I/1WeTwu+deCbgKMGbUijeXhtfbxSxm6JwGrXrhBdofTsbKRUsrN1WoNgUa8uqN1Vx6WAJw1JHPhglEGGHea6QICwJOAr/6mrui/oB7pkaWKHj3z7d1IC4KWLtY47elvjbaTlkN04Kc/5LFEirorGYVbt15kAUlqGM65pk6ZBxtaO3+30LVlORZkxOh+LKL/BvbZ/iRNhItLqNyieoQj/uh/7Iv4uyH/cV/0b4WDSd3DptigWq84lJubb9t/DnZlrJazxyDCulTmKdOR7vs9gMTo+uoIrPSb8ScTtvw65+odKAlBj59dhnVp9zd7QUojOpXlL62Aw56U4oO+FALuevvMjiWeavKhJqlR7i5n9srYcrNV7ttmDw7kf/97P5zauIhxcjX+xHv4M=
          EOF
          chmod 600 ~/.ssh/known_hosts
      - uses: webfactory/ssh-agent@dc588b651fe13675774614f8e6a936a468676387 # v0.9.0
        with:
          ssh-private-key: ${{ secrets.BITBUCKET_SSH_KEY }}
      - name: Mirror to Bitbucket
        run: |
          git remote add bitbucket git@bitbucket.org:hyperpolymath/${GITHUB_REPOSITORY#*/}.git || true
          git push bitbucket --all --force
          git push bitbucket --tags --force
