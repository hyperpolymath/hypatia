// SPDX-License-Identifier: PMPL-1.0-or-later
= CII Best Practices Badge Enforcement Architecture
:toc: macro
:toclevels: 3
:icons: font

image:https://www.bestpractices.dev/projects/XXXX/badge[OpenSSF Best Practices]

toc::[]

== Overview

This document describes how cicd-hyper-a enforces OpenSSF CII Best Practices
criteria across the hyperpolymath organization using a hybrid centralized/local
approach.

=== Philosophy

[quote]
"Central prevention, local compliance"

* *Preventive rules* run centrally via git hooks, blocking non-compliant commits
* *Curative fixes* are applied automatically via robot-repo-automaton
* *Per-repo artifacts* (README, tests) are seeded from templates
* *Badge registration* is per-project at bestpractices.dev

== CII Criteria Mapping

=== Centralized Enforcement (cicd-hyper-a)

These criteria are enforced automatically across all repos:

[cols="2,2,3"]
|===
| CII Criterion | Enforcement Method | Implementation

| *License*
| Pre-commit hook
| `block_commit_if(Commit, missing_spdx)` - SPDX headers required

| *No Secrets*
| Pre-commit hook
| `block_commit_if(Commit, secret_detected)` - PAT/key patterns blocked

| *SHA-Pinned Deps*
| Pre-commit hook
| `block_commit_if(Commit, unpinned_action)` - @v1 blocked, @SHA required

| *Workflow Permissions*
| Pre-commit hook
| `block_commit_if(Commit, missing_permissions)` - read-all required

| *Security Reporting*
| Auto-fix rule
| `auto_fix(Repo, missing_security_md)` - SECURITY.md injected

| *Branch Protection*
| Auto-fix rule
| `auto_fix(Repo, missing_branch_protection)` - enabled via API

| *Secure Design*
| Language policy
| RSR language restrictions prevent insecure patterns
|===

=== Local Enforcement (Per-Repo)

These criteria require per-repo configuration:

[cols="2,2,3"]
|===
| CII Criterion | Enforcement Method | Implementation

| *Documentation*
| Template seeding
| README.adoc from rsr-template-repo

| *Contribution Guidelines*
| Template seeding
| CONTRIBUTING.adoc from rsr-template-repo

| *Version Control*
| GitHub
| All repos public, URL accessible

| *Bug Reporting*
| GitHub Issues
| Enabled by default on all repos

| *Vulnerability Response*
| SECURITY.md
| Private security reporting enabled

| *Test Suite*
| Language-specific CI
| Rust: cargo test, ReScript: deno test, etc.

| *Build System*
| Language-specific
| Cargo, Deno, Just, Guix
|===

=== API Registration (Automatable)

The bestpractices.dev platform provides a REST API for programmatic registration:

[source,bash]
----
# Create project
POST /projects

# Update project criteria
PATCH /projects/:id
PUT   /projects/:id

# Get badge status
GET /projects/:id/badge.json
----

*Implementation*: `cicd-hyper-a/tools/cii-registrar/` (Rust CLI)

=== Manual Steps (Per-Project)

These require human intervention:

[cols="2,2,3"]
|===
| CII Criterion | Why Manual | Process

| *Badge Registration*
| Self-certification (or API)
| Register at https://www.bestpractices.dev or via API

| *Fuzzing*
| Resource-intensive
| OSS-Fuzz or ClusterFuzzLite integration

| *Code Review*
| Human judgment
| PRs require 1 approving review
|===

== Hook Propagation

=== Installation

cicd-hyper-a hooks are installed via:

[source,bash]
----
# Clone cicd-hyper-a
git clone https://github.com/hyperpolymath/cicd-hyper-a.git ~/.cicd-hyper-a

# Install hooks for a repo
~/.cicd-hyper-a/install.sh /path/to/repo

# Or install globally
git config --global core.hooksPath ~/.cicd-hyper-a/hooks
----

=== Hook Chain

[source]
----
git commit
    │
    ▼
┌────────────────────────────────────────┐
│ pre-commit (cicd-hyper-a)              │
│                                        │
│  ┌─ Language Policy ──────────────┐    │
│  │ No TypeScript, Go, Python      │    │
│  └────────────────────────────────┘    │
│                                        │
│  ┌─ SPDX Headers ─────────────────┐    │
│  │ All files must have header     │    │
│  └────────────────────────────────┘    │
│                                        │
│  ┌─ Workflow Security ────────────┐    │
│  │ SHA-pinned, permissions set    │    │
│  └────────────────────────────────┘    │
│                                        │
│  ┌─ Secret Detection ─────────────┐    │
│  │ No PATs, AWS keys, etc.        │    │
│  └────────────────────────────────┘    │
└────────────────────────────────────────┘
    │
    ▼ (if all pass)
git push
    │
    ▼
┌────────────────────────────────────────┐
│ pre-push (cicd-hyper-a)                │
│                                        │
│  ┌─ Signature Verification ───────┐    │
│  │ All commits must be signed     │    │
│  └────────────────────────────────┘    │
│                                        │
│  ┌─ CI Simulation ────────────────┐    │
│  │ Run local checks before push   │    │
│  └────────────────────────────────┘    │
└────────────────────────────────────────┘
    │
    ▼ (remote)
┌────────────────────────────────────────┐
│ GitHub Actions (via scorecard.yml)     │
│                                        │
│  ┌─ OpenSSF Scorecard ────────────┐    │
│  │ Automated security scoring     │    │
│  └────────────────────────────────┘    │
│                                        │
│  ┌─ CodeQL ───────────────────────┐    │
│  │ Static analysis                │    │
│  └────────────────────────────────┘    │
│                                        │
│  ┌─ Dependabot ───────────────────┐    │
│  │ Dependency updates             │    │
│  └────────────────────────────────┘    │
└────────────────────────────────────────┘
----

== Badge Registration

=== Step 1: Check Compliance

[source,bash]
----
# Run scorecard locally
scorecard --repo=github.com/hyperpolymath/REPO --show-details

# Check for required files
test -f SECURITY.md && echo "✓ SECURITY.md"
test -f CONTRIBUTING.adoc && echo "✓ CONTRIBUTING"
test -f LICENSE && echo "✓ LICENSE"
----

=== Step 2: Register at bestpractices.dev

1. Go to https://www.bestpractices.dev/en/projects/new
2. Enter repository URL
3. Answer questionnaire (most answers auto-populated)
4. Submit for passing badge

=== Step 3: Add Badge to README

[source,asciidoc]
----
image:https://www.bestpractices.dev/projects/PROJECT_ID/badge[OpenSSF Best Practices]
----

== Logtalk Rule Engine

The rule engine in `engine/rules/cicd_rules.lgt` contains:

=== Declarative Rules
[source,prolog]
----
repo_must_have(Repo, 'SECURITY.md') :-
    repo_is_public(Repo).

repo_must_have(Repo, '.github/dependabot.yml') :-
    repo_uses_dependencies(Repo).
----

=== Preventive Rules
[source,prolog]
----
block_commit_if(Commit, missing_spdx) :-
    commit_adds_file(Commit, File),
    \+ file_has_spdx_header(File).
----

=== Curative Rules
[source,prolog]
----
auto_fix(Repo, missing_security_md) :-
    \+ repo_has_file(Repo, 'SECURITY.md'),
    inject_security_md(Repo).
----

=== Severity Classification
[source,prolog]
----
classify_severity('CIIBestPracticesID', low).
suggest_fix('CIIBestPracticesID',
    'Register at bestpractices.coreinfrastructure.org').
----

== Integration with robot-repo-automaton

The automaton uses cicd-hyper-a rules for:

1. *Preventive injection* - New repos get hooks installed
2. *Curative sweeps* - Existing repos get missing files added
3. *Compliance monitoring* - Scorecard alerts trigger auto-fixes

[source,yaml]
----
# robot-repo-automaton/config.yml
cicd_hyper_a:
  enabled: true
  global_rulesets:
    - hyperpolymath/rsr-compliance
    - hyperpolymath/security-baseline
    - hyperpolymath/cii-passing  # CII Best Practices ruleset
----

== Current Status

=== Repos with Passing Badge

None yet - registration in progress (2026-01-04).

=== Priority Registration List (Tier 1 - Core Infrastructure)

[cols="2,1,1,1,1"]
|===
| Repo | Type | SEC | CI | Priority

| cicd-hyper-a
| Infrastructure
| ✓
| ✓
| Critical

| rhodium-standard-repositories
| Standards
| ✓
| ✓
| Critical

| robot-vacuum-cleaner
| Automation
| ✓
| ✓
| Critical

| supernorma
| Validation
| ✓
| ✓
| High

| bunsenite
| Config Lang
| ✓
| ✓
| High
|===

=== Tier 2 - Active Projects (15 repos)

- echidnabot, czech-file-knife, ubicity, affinescript
- llm-verify, polyglot-i18n, januskey, proof-of-work
- gitloom, reposystem, thejerffparadox, polysafe-gitfixer
- valence-shell, git-seo, laminar

=== Tier 3 - All Other Ready Repos

*161 repos* meet basic CII requirements (SECURITY.md, LICENSE, README, CI).

Run `/tmp/check-cii-readiness.sh` to list all ready repos.

=== Automation Roadmap

1. *Phase 1*: Manual registration of Tier 1 repos (5 repos)
2. *Phase 2*: Build `cii-registrar` Rust CLI using bestpractices.dev API
3. *Phase 3*: Batch registration of Tier 2/3 repos
4. *Phase 4*: Add badge SVGs to all READMEs

== Related Links

* https://www.bestpractices.dev[OpenSSF Best Practices Badge Program]
* https://openssf.org/projects/best-practices-badge/[OpenSSF Project Page]
* https://github.com/coreinfrastructure/best-practices-badge[Badge Program GitHub]
