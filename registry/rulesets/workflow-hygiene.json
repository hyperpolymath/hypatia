{
  "$schema": "../schemas/ruleset.schema.json",
  "_comment": "SPDX-License-Identifier: AGPL-3.0-or-later",
  "name": "workflow-hygiene",
  "version": "1.0.0",
  "description": "GitHub Actions workflow hygiene rules. Enforces SPDX headers, permissions, SHA-pinning, and trigger limits.",
  "author": {
    "name": "hyperpolymath",
    "url": "https://github.com/hyperpolymath"
  },
  "license": "AGPL-3.0-or-later",
  "effect": "preventive",
  "targets": {
    "forges": ["github"],
    "frameworks": ["github-actions"]
  },
  "rules": [
    {
      "id": "require-spdx-header",
      "name": "Require SPDX Header",
      "description": "All workflow files must begin with an SPDX license identifier comment.",
      "effect": "preventive",
      "severity": "medium",
      "condition": {
        "type": "and",
        "conditions": [
          { "type": "file-extension", "path": ".github/workflows/*", "extension": ".yml" },
          {
            "type": "not",
            "conditions": [
              { "type": "file-contains", "path": ".github/workflows/*.yml", "pattern": "^#\\s*SPDX-License-Identifier:" }
            ]
          }
        ]
      },
      "action": {
        "type": "alert",
        "severity": "medium",
        "message": "Workflow file missing SPDX header. Add '# SPDX-License-Identifier: AGPL-3.0-or-later' as the first line."
      },
      "autoFixable": true,
      "confidence": 0.95,
      "source": "learned",
      "learnedFrom": {
        "repos": 114,
        "occurrences": 456,
        "pattern": "Workflow files without license headers"
      }
    },
    {
      "id": "require-permissions-read-all",
      "name": "Require permissions: read-all",
      "description": "All workflows must declare explicit permissions with read-all default for security.",
      "effect": "preventive",
      "severity": "high",
      "condition": {
        "type": "and",
        "conditions": [
          { "type": "file-extension", "path": ".github/workflows/*", "extension": ".yml" },
          {
            "type": "not",
            "conditions": [
              { "type": "file-contains", "path": ".github/workflows/*.yml", "pattern": "permissions:\\s*(read-all|\\{)" }
            ]
          }
        ]
      },
      "action": {
        "type": "alert",
        "severity": "high",
        "message": "Workflow missing permissions declaration. Add 'permissions: read-all' at workflow level for OpenSSF Token-Permissions compliance."
      },
      "autoFixable": true,
      "confidence": 0.9,
      "source": "learned",
      "learnedFrom": {
        "repos": 114,
        "occurrences": 312,
        "pattern": "Workflows without explicit permissions"
      }
    },
    {
      "id": "sha-pin-actions",
      "name": "SHA-Pin All Actions",
      "description": "All 'uses:' statements must reference full SHA commit hashes, not version tags.",
      "effect": "preventive",
      "severity": "high",
      "condition": {
        "type": "file-contains",
        "path": ".github/workflows/*.yml",
        "pattern": "uses:\\s+[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+@v[0-9]"
      },
      "action": {
        "type": "alert",
        "severity": "high",
        "message": "Action uses version tag instead of SHA. Pin to full commit SHA for security. Example: uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4"
      },
      "autoFixable": true,
      "confidence": 0.85,
      "source": "learned",
      "learnedFrom": {
        "repos": 114,
        "occurrences": 847,
        "pattern": "Unpinned GitHub Actions"
      }
    },
    {
      "id": "sha-pin-main-branch",
      "name": "Block Actions Pinned to main/master",
      "description": "Actions should never be pinned to main or master branch - these are unstable references.",
      "effect": "preventive",
      "severity": "critical",
      "condition": {
        "type": "file-contains",
        "path": ".github/workflows/*.yml",
        "pattern": "uses:\\s+[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+@(main|master)\\s*$"
      },
      "action": {
        "type": "reject-commit",
        "message": "Action pinned to main/master branch detected. This is a critical security risk. Always pin to full SHA."
      },
      "autoFixable": true,
      "confidence": 0.95,
      "source": "manual"
    },
    {
      "id": "limit-workflow-triggers",
      "name": "Limit Workflow Triggers",
      "description": "Workflows should not trigger on too many events. Limit triggers to prevent excessive CI usage.",
      "effect": "diagnostic",
      "severity": "low",
      "condition": {
        "type": "file-contains",
        "path": ".github/workflows/*.yml",
        "pattern": "on:\\s*\\[[^\\]]{100,}\\]"
      },
      "action": {
        "type": "alert",
        "severity": "low",
        "message": "Workflow has many event triggers. Consider limiting triggers to reduce CI costs and complexity."
      },
      "autoFixable": false,
      "source": "manual"
    },
    {
      "id": "require-workflow-name",
      "name": "Require Workflow Name",
      "description": "All workflows must have a descriptive name field.",
      "effect": "preventive",
      "severity": "low",
      "condition": {
        "type": "and",
        "conditions": [
          { "type": "file-extension", "path": ".github/workflows/*", "extension": ".yml" },
          {
            "type": "not",
            "conditions": [
              { "type": "file-contains", "path": ".github/workflows/*.yml", "pattern": "^name:" }
            ]
          }
        ]
      },
      "action": {
        "type": "alert",
        "severity": "low",
        "message": "Workflow file missing 'name' field. Add a descriptive name for better CI visibility."
      },
      "autoFixable": false,
      "source": "manual"
    },
    {
      "id": "block-workflow-dispatch-secrets",
      "name": "Block Secrets in workflow_dispatch",
      "description": "Secrets should not be passed via workflow_dispatch inputs - they can be logged.",
      "effect": "preventive",
      "severity": "critical",
      "condition": {
        "type": "file-contains",
        "path": ".github/workflows/*.yml",
        "pattern": "workflow_dispatch:[\\s\\S]*?inputs:[\\s\\S]*?type:\\s*(string|choice)[\\s\\S]*?(secret|token|key|password)"
      },
      "action": {
        "type": "alert",
        "severity": "critical",
        "message": "Potential secret in workflow_dispatch input. Secrets passed via inputs can be logged. Use repository secrets instead."
      },
      "autoFixable": false,
      "source": "manual"
    },
    {
      "id": "block-pull-request-target",
      "name": "Warn on pull_request_target",
      "description": "pull_request_target gives write access to forked PRs - use with extreme caution.",
      "effect": "diagnostic",
      "severity": "high",
      "condition": {
        "type": "file-contains",
        "path": ".github/workflows/*.yml",
        "pattern": "on:[\\s\\S]*?pull_request_target"
      },
      "action": {
        "type": "alert",
        "severity": "high",
        "message": "pull_request_target detected. This event runs with repository write access even for forked PRs. Ensure checkout is from PR head, not base."
      },
      "autoFixable": false,
      "source": "manual"
    },
    {
      "id": "require-timeout",
      "name": "Require Job Timeout",
      "description": "Jobs should have timeout-minutes to prevent runaway builds.",
      "effect": "diagnostic",
      "severity": "low",
      "condition": {
        "type": "and",
        "conditions": [
          { "type": "file-extension", "path": ".github/workflows/*", "extension": ".yml" },
          {
            "type": "not",
            "conditions": [
              { "type": "file-contains", "path": ".github/workflows/*.yml", "pattern": "timeout-minutes:" }
            ]
          }
        ]
      },
      "action": {
        "type": "alert",
        "severity": "low",
        "message": "Workflow jobs without timeout-minutes. Add timeout-minutes to prevent stuck jobs from consuming resources."
      },
      "autoFixable": true,
      "confidence": 0.7,
      "source": "manual"
    },
    {
      "id": "block-env-secrets-in-run",
      "name": "Block Inline Secrets in run Steps",
      "description": "Secrets should not be directly interpolated in run steps - use environment variables instead.",
      "effect": "preventive",
      "severity": "high",
      "condition": {
        "type": "file-contains",
        "path": ".github/workflows/*.yml",
        "pattern": "run:[^\\n]*\\$\\{\\{\\s*secrets\\."
      },
      "action": {
        "type": "alert",
        "severity": "high",
        "message": "Secret interpolated directly in run step. Use 'env:' to pass secrets to scripts instead of inline interpolation."
      },
      "autoFixable": false,
      "source": "manual"
    }
  ],
  "verification": {
    "verified": true,
    "verifiedAt": "2026-01-18T00:00:00Z",
    "verifier": "manual-review",
    "properties": [
      { "name": "idempotent", "status": "proven", "proof": "All rules are file content checks" },
      { "name": "no-regression", "status": "tested", "proof": "Tested against 114 repos with 847 workflow files" },
      { "name": "openssf-aligned", "status": "proven", "proof": "Directly maps to OpenSSF Scorecard Token-Permissions and Pinned-Dependencies checks" }
    ]
  }
}
