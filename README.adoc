// SPDX-License-Identifier: AGPL-3.0-or-later
= CI/CD Hyper-A: Neurosymbolic CI/CD Intelligence Platform
:toc: macro
:toclevels: 3
:icons: font

image:https://img.shields.io/badge/license-AGPL--3.0-blue.svg[License]
image:https://img.shields.io/badge/philosophy-Palimpsest-purple.svg[Palimpsest,link="https://github.com/hyperpolymath/palimpsest-licence"]
image:https://img.shields.io/badge/Logtalk-Rules-orange.svg[Logtalk]
image:https://img.shields.io/badge/Haskell-Verification-5D4F85.svg[Haskell]
image:https://img.shields.io/badge/ArangoDB-Graph-green.svg[ArangoDB]

toc::[]

== Overview

*cicd-hyper-a* is a neurosymbolic CI/CD intelligence platform that combines:

* *Neural Learning*: Pattern recognition from CI/CD failures across ecosystems
* *Symbolic Reasoning*: Logtalk/Prolog rules for fast, deterministic actions
* *Formal Verification*: Haskell-based ruleset validation and registry
* *Graph Intelligence*: ArangoDB for relationship modeling
* *Distributed Cache*: Dragonfly for sub-millisecond rule lookups
* *P2P Federation*: Radicle for decentralized ruleset distribution

=== Core Philosophy

[quote]
"Dumb rules from smart learning"

The system learns complex patterns through neural analysis, then *distills* them into simple, fast-acting declarative rules that can be:

* Pre-emptively injected into new repositories
* Applied as cures to existing repositories  
* Executed without ML inference overhead
* Formally verified for correctness

== Architecture

[source]
----
┌─────────────────────────────────────────────────────────────────────┐
│                      cicd-hyper-a Platform                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                 VERIFICATION LAYER (Haskell)                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌───────────────────────┐   │ │
│  │  │ Type-Safe   │  │ Property    │  │ Formal Proof          │   │ │
│  │  │ Ruleset DSL │  │ Testing     │  │ (Liquid Haskell)      │   │ │
│  │  └─────────────┘  └─────────────┘  └───────────────────────┘   │ │
│  │                          │                                      │ │
│  │  ┌─────────────────────────────────────────────────────────┐   │ │
│  │  │              RULESET REGISTRY (Git-Native)               │   │ │
│  │  │  - Deposit: Submit verified rulesets                     │   │ │
│  │  │  - Withdraw: Pull rulesets for local use                 │   │ │
│  │  │  - Authority: Signed, versioned, auditable               │   │ │
│  │  └─────────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                 LEARNING LAYER (Neural)                        │ │
│  │  Pattern Recognition → Anomaly Detection → Rule Distillation   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │              SYMBOLIC LAYER (Logtalk + Prolog)                 │ │
│  │  Declarative Rules │ Imperative Procedures │ Inference Engine  │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                    DATA LAYER                                   │ │
│  │  ArangoDB (Graph) │ Dragonfly (Cache) │ Radicle (P2P Git)      │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                   ACTION LAYER                                  │ │
│  │  robot-repo-automaton │ Hooks │ Diagnostics │ Auto-Repair      │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                              │                                       │
│                              ▼                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                  FORGE ADAPTERS                                 │ │
│  │  GitHub │ GitLab │ Bitbucket │ Codeberg │ sr.ht │ Gitea        │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
----

== Haskell Verification Registry

The *Ruleset Registry* is a Haskell-based system providing:

=== Type-Safe Ruleset DSL

[source,haskell]
----
{-# LANGUAGE GADTs #-}
{-# LANGUAGE DataKinds #-}

module CicdHyperA.Ruleset where

-- | Rule effect types
data Effect = Preventive | Curative | Diagnostic

-- | Type-safe rule definition
data Rule (e :: Effect) where
  PreventiveRule :: RuleName -> Condition -> Action -> Rule 'Preventive
  CurativeRule   :: RuleName -> Pattern -> Fix -> Rule 'Curative
  DiagnosticRule :: RuleName -> Check -> Report -> Rule 'Diagnostic

-- | Condition language
data Condition
  = FileExists FilePath
  | FileContains FilePath Pattern
  | LanguageUsed Language
  | DependencyPresent Package
  | And Condition Condition
  | Or Condition Condition
  | Not Condition

-- | Example rules
requireDependabot :: Rule 'Preventive
requireDependabot = PreventiveRule
  "require-dependabot"
  (Not (FileExists ".github/dependabot.yml"))
  (InjectFile ".github/dependabot.yml" dependabotTemplate)

blockTypeScript :: Rule 'Preventive  
blockTypeScript = PreventiveRule
  "block-typescript"
  (Or (LanguageUsed TypeScript) (FileExists "*.ts"))
  (RejectCommit "TypeScript not allowed per RSR policy")
----

=== Property-Based Testing

[source,haskell]
----
module CicdHyperA.Properties where

import Test.QuickCheck

-- | Rules must be deterministic
prop_deterministic :: Rule e -> Repo -> Bool
prop_deterministic rule repo =
  evaluate rule repo == evaluate rule repo

-- | Preventive rules must not modify existing files
prop_preventive_safe :: Rule 'Preventive -> Repo -> Property
prop_preventive_safe rule repo =
  let repo' = apply rule repo
  in all (unchanged repo repo') (existingFiles repo)

-- | Curative rules must improve health score
prop_curative_improves :: Rule 'Curative -> Repo -> Property
prop_curative_improves rule repo =
  healthScore repo < healthScore (apply rule repo)
----

=== Formal Verification (Liquid Haskell)

[source,haskell]
----
{-@ LIQUID "--reflection" @-}

module CicdHyperA.Verified where

-- | Refinement type: health score always in range
{-@ type HealthScore = {v:Int | 0 <= v && v <= 100} @-}

-- | Verified: curative rules never decrease health
{-@ curativeImproves :: Rule 'Curative -> Repo -> 
      {r:Repo | healthScore r >= healthScore repo} @-}
curativeImproves :: Rule 'Curative -> Repo -> Repo
curativeImproves rule repo = apply rule repo

-- | Verified: preventive rules preserve existing content
{-@ preventiveSafe :: Rule 'Preventive -> Repo ->
      {r:Repo | existingFiles r == existingFiles repo} @-}
preventiveSafe :: Rule 'Preventive -> Repo -> Repo
preventiveSafe rule repo = apply rule repo
----

=== Registry Operations

[cols="1,3"]
|===
| Operation | Description

| `deposit`
| Submit a verified ruleset to the registry. Requires passing all property tests and formal verification.

| `withdraw`
| Pull a ruleset for local use. Includes signature verification and version pinning.

| `search`
| Query rulesets by effect type, target forge, language, or category.

| `audit`
| View the complete history of a ruleset including all changes and verifications.

| `fork`
| Create a derived ruleset with custom modifications while maintaining provenance.
|===

[source,bash]
----
# Deposit a new ruleset
cicd-hyper-a deposit ./my-ruleset.hs \
  --name "rust-security-hardening" \
  --description "Security rules for Rust projects" \
  --sign --verify

# Withdraw for local use
cicd-hyper-a withdraw rust-security-hardening \
  --version "1.2.0" \
  --output ./rules/

# Search for rulesets
cicd-hyper-a search --effect preventive --language rust

# Audit a ruleset
cicd-hyper-a audit rust-security-hardening --full
----

== Integration with robot-repo-automaton

The platform integrates with link:https://github.com/hyperpolymath/robot-repo-automaton[robot-repo-automaton] for automated repository management:

[source,yaml]
----
# robot-repo-automaton/config.yml
cicd_hyper_a:
  enabled: true
  registry_url: https://registry.cicd-hyper-a.hyperpolymath.dev
  
  # Rulesets to apply to all repos
  global_rulesets:
    - hyperpolymath/rsr-compliance
    - hyperpolymath/security-baseline
    - hyperpolymath/quality-gates
  
  # Language-specific rulesets
  language_rulesets:
    rust:
      - hyperpolymath/rust-clippy-strict
      - hyperpolymath/rust-fuzzing
    rescript:
      - hyperpolymath/rescript-deno
    gleam:
      - hyperpolymath/gleam-beam
  
  # Automation settings
  automation:
    auto_fix_threshold: 0.95  # Auto-apply fixes with >95% confidence
    pr_threshold: 0.80        # Create PR for 80-95% confidence
    alert_threshold: 0.50     # Alert human for <80% confidence
----

=== Hook Integration

[source,bash]
----
#!/bin/bash
# .git/hooks/pre-commit (injected by cicd-hyper-a)

# Load rulesets from registry (cached in Dragonfly)
cicd-hyper-a hooks pre-commit \
  --rulesets hyperpolymath/rsr-compliance \
  --cache-ttl 3600

# Runs preventive rules:
# - Language policy (no TS, Go, Python, Makefile)
# - Secret detection
# - Formatting checks
# - License headers
----

[source,bash]
----
#!/bin/bash
# .git/hooks/pre-push

cicd-hyper-a hooks pre-push \
  --rulesets hyperpolymath/security-baseline \
  --verify-signatures

# Runs validation:
# - All commits signed
# - CI simulation passes
# - No breaking API changes
----

== Logtalk Rule Engine

The symbolic layer uses Logtalk for high-performance rule execution:

[source,prolog]
----
:- object(cicd_rules).

    %% DECLARATIVE RULES
    repo_must_have(Repo, 'dependabot.yml') :-
        repo_uses_dependencies(Repo).
    repo_must_have(Repo, 'SECURITY.md') :-
        repo_is_public(Repo).

    %% PREVENTIVE RULES
    block_commit_if(Commit, typescript_detected) :-
        commit_adds_file(Commit, File),
        file_extension(File, '.ts').
    block_commit_if(Commit, secret_detected) :-
        commit_content_matches(Commit, Pattern),
        secret_pattern(Pattern).

    %% CURATIVE RULES
    auto_fix(Repo, unpinned_actions) :-
        find_unpinned_actions(Repo, Actions),
        pin_actions_to_sha(Repo, Actions).

:- end_object.
----

== Data Layer

=== ArangoDB Graph Schema

[source,json]
----
{
  "collections": {
    "repos": { "type": "document" },
    "rules": { "type": "document" },
    "patterns": { "type": "document" },
    "rulesets": { "type": "document" }
  },
  "edge_collections": {
    "repo_uses_ruleset": { "from": ["repos"], "to": ["rulesets"] },
    "ruleset_contains": { "from": ["rulesets"], "to": ["rules"] },
    "rule_derived_from": { "from": ["rules"], "to": ["patterns"] }
  }
}
----

=== Dragonfly Cache Strategy

[source,yaml]
----
# Compiled rules for instant execution
rules:
  key: "rule:{ruleset}:{rule_id}"
  ttl: 3600
  data: compiled_bytecode

# Repo state for quick lookups
repos:
  key: "repo:{forge}:{owner}:{name}"
  ttl: 300
  data: { health_score, issues, rulesets_applied }

# Registry index for fast search
registry:
  key: "registry:index:{category}"
  ttl: 86400
  data: [ruleset_ids]
----

== Repository Structure

[source]
----
cicd-hyper-a/
├── registry/                    # Haskell verification registry
│   ├── src/
│   │   ├── CicdHyperA/
│   │   │   ├── Ruleset.hs      # Type-safe DSL
│   │   │   ├── Verify.hs       # Property tests
│   │   │   ├── Liquid.hs       # Formal proofs
│   │   │   ├── Registry.hs     # Git-based storage
│   │   │   └── API.hs          # REST/GraphQL API
│   │   └── Main.hs
│   ├── test/
│   └── cicd-hyper-a.cabal
│
├── engine/                      # Logtalk rule engine
│   ├── rules/
│   │   ├── cicd_rules.lgt
│   │   ├── rule_distiller.lgt
│   │   └── forge_adapters.lgt
│   └── loader.lgt
│
├── hooks/                       # Git hook templates
│   ├── pre-commit
│   ├── pre-push
│   └── post-receive
│
├── schemas/                     # Data schemas
│   ├── arangodb.json
│   ├── dragonfly.yml
│   └── ruleset.schema.json
│
├── adapters/                    # Forge adapters
│   ├── github.rs
│   ├── gitlab.rs
│   ├── bitbucket.rs
│   └── radicle.rs
│
├── integration/                 # External integrations
│   ├── robot-repo-automaton/
│   └── gitvisor/
│
└── deploy/                      # Deployment configs
    ├── k8s/
    ├── docker-compose.yml
    └── helm/
----

== Roadmap

=== Phase 1: Foundation
* [x] Logtalk rule engine
* [x] ArangoDB schema
* [ ] Haskell DSL core
* [ ] Basic registry operations

=== Phase 2: Verification
* [ ] Property-based testing framework
* [ ] Liquid Haskell integration
* [ ] Signature verification
* [ ] Audit logging

=== Phase 3: Integration
* [ ] robot-repo-automaton connector
* [ ] Hook injection system
* [ ] Multi-forge adapters
* [ ] Dragonfly caching

=== Phase 4: Scale
* [ ] K8s orchestration
* [ ] Radicle P2P federation
* [ ] Public registry launch
* [ ] Enterprise features

== Related Projects

* link:https://github.com/hyperpolymath/robot-repo-automaton[robot-repo-automaton] - Automated repository management
* link:https://github.com/hyperpolymath/gitvisor[gitvisor] - CI/CD intelligence system
* link:https://github.com/hyperpolymath/rhodium-standard-repositories[rhodium-standard-repositories] - Repository standards
* link:https://github.com/hyperpolymath/palimpsest-licence[palimpsest-licence] - Philosophical licence

== License

This project is dual-licensed under:

* link:https://www.gnu.org/licenses/agpl-3.0[AGPL-3.0-or-later] (legal)
* link:https://github.com/hyperpolymath/palimpsest-licence[Palimpsest Licence] (philosophical)
