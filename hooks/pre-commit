#!/bin/bash
# SPDX-License-Identifier: PLMP-1.0-or-later
# cicd-hyper-a Pre-Commit Hook
# Prevents commits that violate RSR policy

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}cicd-hyper-a pre-commit checks${NC}"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No staged files to check${NC}"
    exit 0
fi

ERRORS=0

# ============================================================
# RSR LANGUAGE POLICY
# ============================================================

# Check for TypeScript files
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)
if [ -n "$TS_FILES" ]; then
    echo -e "${RED}ERROR: TypeScript files not allowed per RSR policy${NC}"
    echo "Use ReScript instead. Files found:"
    echo "$TS_FILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for Go files
GO_FILES=$(echo "$STAGED_FILES" | grep -E '\.go$' || true)
if [ -n "$GO_FILES" ]; then
    echo -e "${RED}ERROR: Go files not allowed per RSR policy${NC}"
    echo "Use Rust instead. Files found:"
    echo "$GO_FILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for Python files (except SaltStack)
PY_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' | grep -v '^salt/' || true)
if [ -n "$PY_FILES" ]; then
    echo -e "${RED}ERROR: Python files not allowed per RSR policy (except SaltStack)${NC}"
    echo "Use ReScript or Rust instead. Files found:"
    echo "$PY_FILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for package-lock.json or node_modules
NODE_FILES=$(echo "$STAGED_FILES" | grep -E '(package-lock\.json|node_modules/)' || true)
if [ -n "$NODE_FILES" ]; then
    echo -e "${RED}ERROR: Node.js artifacts not allowed per RSR policy${NC}"
    echo "Use Deno instead. Files found:"
    echo "$NODE_FILES"
    ERRORS=$((ERRORS + 1))
fi

# Check for Makefile
MAKE_FILES=$(echo "$STAGED_FILES" | grep -E '^Makefile$' || true)
if [ -n "$MAKE_FILES" ]; then
    echo -e "${RED}ERROR: Makefile not allowed per RSR policy${NC}"
    echo "Use Just, Guix, or Nix instead."
    ERRORS=$((ERRORS + 1))
fi

# ============================================================
# SPDX LICENSE HEADERS
# ============================================================

for file in $STAGED_FILES; do
    # Skip binary files and certain file types
    if [[ "$file" =~ \.(png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|pdf|lock)$ ]]; then
        continue
    fi

    # Skip JSON files (no comment syntax)
    if [[ "$file" =~ \.json$ ]]; then
        continue
    fi

    # Check for SPDX header
    if [ -f "$file" ]; then
        if ! head -5 "$file" | grep -q "SPDX-License-Identifier"; then
            echo -e "${YELLOW}WARNING: Missing SPDX header in $file${NC}"
            # Don't fail, just warn
        fi
    fi
done

# ============================================================
# WORKFLOW SECURITY CHECKS
# ============================================================

WORKFLOW_FILES=$(echo "$STAGED_FILES" | grep -E '\.github/workflows/.*\.ya?ml$' || true)
for wf in $WORKFLOW_FILES; do
    if [ -f "$wf" ]; then
        # Check for unpinned actions
        if grep -E 'uses:\s+[^@]+@(v[0-9]+|main|master)\s*$' "$wf" > /dev/null 2>&1; then
            echo -e "${RED}ERROR: Unpinned GitHub Action in $wf${NC}"
            echo "Use SHA-pinned actions (e.g., @abc123 # v1)"
            grep -n 'uses:' "$wf" | grep -E '@(v[0-9]+|main|master)\s*$'
            ERRORS=$((ERRORS + 1))
        fi

        # Check for missing permissions
        if ! grep -q 'permissions:' "$wf"; then
            echo -e "${YELLOW}WARNING: Missing permissions declaration in $wf${NC}"
            echo "Add 'permissions: read-all' at workflow level"
        fi
    fi
done

# ============================================================
# SECRET DETECTION
# ============================================================

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Check for hardcoded secrets (common patterns)
        if grep -E '(api[_-]?key|secret|password|token)\s*[=:]\s*["\x27][A-Za-z0-9+/=]{20,}["\x27]' "$file" > /dev/null 2>&1; then
            echo -e "${RED}ERROR: Possible hardcoded secret in $file${NC}"
            ERRORS=$((ERRORS + 1))
        fi

        # Check for GitHub PAT patterns
        if grep -E 'ghp_[a-zA-Z0-9]{36}' "$file" > /dev/null 2>&1; then
            echo -e "${RED}ERROR: GitHub PAT detected in $file${NC}"
            ERRORS=$((ERRORS + 1))
        fi

        # Check for AWS access keys
        if grep -E 'AKIA[0-9A-Z]{16}' "$file" > /dev/null 2>&1; then
            echo -e "${RED}ERROR: AWS access key detected in $file${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# ============================================================
# RESULT
# ============================================================

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}Pre-commit checks failed with $ERRORS error(s)${NC}"
    echo "Fix the issues above or use 'git commit --no-verify' to bypass (not recommended)"
    exit 1
fi

echo -e "${GREEN}All pre-commit checks passed${NC}"
exit 0
