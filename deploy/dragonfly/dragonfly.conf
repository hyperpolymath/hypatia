# SPDX-License-Identifier: PMPL-1.0-or-later
# Dragonfly Configuration for cicd-hyper-a
#
# Dragonfly is a Redis-compatible in-memory store optimized for
# modern cloud workloads. This configuration is optimized for
# caching rules, scan results, and fleet status.

# ============================================================
# MEMORY CONFIGURATION
# ============================================================

# Maximum memory limit (2GB for development, increase for production)
--maxmemory=2gb

# Eviction policy when memory limit is reached
# volatile-lru: Evict keys with expiry set using LRU
--maxmemory_policy=volatile-lru

# Enable cache mode for optimized caching behavior
# In cache mode, Dragonfly optimizes for high read throughput
--cache_mode=true

# ============================================================
# PERFORMANCE TUNING
# ============================================================

# Number of proactor threads (adjust based on available cores)
# For development: 2, for production: match available cores
--proactor_threads=2

# Enable pipelining for better throughput
--pipeline_squash=true

# Memory defragmentation threshold (percentage)
--mem_defrag_threshold=0.7

# Enable memory prefetching for better cache performance
--mem_prefetch=true

# ============================================================
# PERSISTENCE
# ============================================================

# Snapshot directory for persistence
--dir=/data

# Save snapshot every 5 minutes if at least 100 keys changed
--save=300:100

# Also save every hour regardless of changes
--save=3600:1

# Use RDB format for snapshots (compatible with Redis)
--dbfilename=dragonfly.rdb

# ============================================================
# NETWORKING
# ============================================================

# Bind to all interfaces (use 127.0.0.1 for local-only)
--bind=0.0.0.0

# Default port
--port=6379

# TCP keepalive (seconds)
--tcp_keepalive=300

# Maximum number of simultaneous client connections
--maxclients=10000

# Timeout for idle connections (0 = no timeout)
--timeout=0

# ============================================================
# LOGGING
# ============================================================

# Log level: debug, info, warning, error
--log_level=info

# Log to stdout (useful for Docker)
--logtostdout=true

# ============================================================
# SECURITY
# ============================================================

# Require password authentication (uncomment for production)
# --requirepass=your_secure_password_here

# Disable dangerous commands (uncomment for production)
# --rename_command=FLUSHALL=""
# --rename_command=FLUSHDB=""
# --rename_command=DEBUG=""

# ============================================================
# CLUSTER AND REPLICATION
# ============================================================

# Enable cluster mode (for multi-node deployments)
# --cluster_mode=emulated

# Replica settings (uncomment for replica nodes)
# --replicaof=master_host:6379

# ============================================================
# MONITORING
# ============================================================

# Enable Prometheus metrics endpoint
--proactor_metrics=true

# Expose metrics on HTTP port
--admin_port=6380

# ============================================================
# CICD-HYPER-A SPECIFIC
# ============================================================

# Key expiration for cache entries:
# - Rules: 3600s (1 hour)
# - Rulesets: 7200s (2 hours)
# - Scan results: 300s (5 minutes)
# - Fleet status: 60s (1 minute)
# - Repo state: 600s (10 minutes)
#
# These are enforced by the application using SETEX commands.
# The maxmemory_policy ensures expired keys are evicted properly.

# Enable pub/sub for cache invalidation events
# Channels used:
# - cache:invalidation - Invalidation events
# - alerts:new - New alert notifications
# - alerts:fixed - Alert fix notifications
# - rules:triggered - Rule trigger events
# - scans:complete - Scan completion events
